---
title: 微信公众号开发：消息管理
copyright: true
date: 2018-10-24 23:19:06
photos:
- https://blog-images-1257621236.cos.ap-shanghai.myqcloud.com/20180313102820207.jpg
tags:
- 微信公众号
categories:
- Wechat
---

微信公众号的消息类型分为*被动回复*、*客服消息*、*群发消息*、*模板消息*等等。

本文会逐一介绍微信公众号的消息类型，包括微信对不同消息的限制、使用场景，以及如何融合不同的消息类型，最大程度上利用微信现有的消息机制，提升公众号的交互能力，增加用户留存率。

<!-- more -->

## 被动回复

微信公众号可以接收*普通消息*（文本、图片、语音等等），*事件推送*（关注、扫码、点击菜单），之后向公众号开发者填写的url `POST`一个XML数据包，公众号开发者可以在**5s**内对收到的消息/事件作出响应（回复文本、图片等等）。

### 限制

服务器需要在五秒内处理收到的消息并回复，否则微信服务器将会发起重试（一共重试三次），同时公众号会向用户下发系统提示`该公众号暂时无法提供服务，请稍后再试`

### 接收普通消息

每种消息类型都有以下属性

|参数  | 描述  | 用途  |
|:---:|:-----:|:----:|
|FromUserName|发送方的`open_id`|开发者可以通过open_id对应到自己的用户信息系统，做一些个性化处理|
|ToUserName|开发者的微信号||
|CreateTime|消息创建的时间|可以联合`FromUserName`参数做消息去重|
|MsgType|消息的类型||
|MsgId|消息的id|消息去重|

消息分为：

- 文本消息：
- 图片消息
- 语音消息
- 视频消息
- 地理位置消息
- 链接消息
- 短视频消息

### 接收事件推送

事件本质上也是一种消息

常见的事件有：

- 关注事件
- 取关事件
- 未关注用户扫描带参数二维码事件：消息中携带了`scene_id`以及二维码`ticket`
- 已关注用户扫描带参数二维码事件：消息中携带了`scene_id`以及二维码`ticket`
- 点击菜单拉取消息事件：消息中携带了自定义菜单`key`
- 点击菜单跳转链接事件：消息中携带了跳转的`url`

### 回复消息类型

- 文本回复
- 图片回复
- 图文回复：10月12日起，*被动回复*与*客服消息*的图文消息类型中图文数目**只能为一条**
- 语音回复
- 视频回复
- 音乐回复

*Tips*: 媒体类型的消息(图片、语音、视频)需要先上传到微信的素材库

## 主动推送

微信开发者可以主动给48小时内活跃的用户（具体活跃的定义见下文）推送不同类型的消息，此场景主要包括活动推送、协同小程序进行服务通知推送等等。

### 限制

需要用户在一定时间内（目前为48小时）与公众号产生以下交互：

- 用户发送信息
- 点击自定义菜单（仅有点击推、扫码推事件）
- 关注公众号
- 扫描二维码

### 回复消息类型

支持的消息回复类型与被动回复相同

发送文本消息时，支持插入跳小程序的文字链

```html
文本内容<a href="http://www.qq.com" data-miniprogram-appid="appid" data-miniprogram-path="pages/index/index">点击跳小程序</a>
```

*Tips*：`data-miniprogram-appid`对应的小程序必须与公众号有绑定关系。

## 群发消息

## 模板消息

## 消息融合
